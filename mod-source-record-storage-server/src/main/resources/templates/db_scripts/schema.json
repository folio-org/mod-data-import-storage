{
  "tables": [
    {
      "tableName": "snapshots",
      "fromModuleVersion": "mod-source-record-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "generateId": false,
      "withAuditing": false,
      "uniqueIndex": [
        {
          "fieldName": "jobExecutionId",
          "tOps": "ADD"
        }
      ],
      "index": [
        {
          "fieldName": "jobExecutionId",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "raw_records",
      "fromModuleVersion": "mod-source-record-storage-2.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "generateId": false,
      "withAuditing": false,
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "marc_records",
      "fromModuleVersion": "mod-source-record-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "generateId": false,
      "withAuditing": false,
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "error_records",
      "fromModuleVersion": "mod-source-record-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "generateId": false,
      "withAuditing": false,
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "records",
      "fromModuleVersion": "mod-source-record-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "generateId": false,
      "withAuditing": false,
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "jobExecutionId",
          "targetTable": "snapshots",
          "tOps": "ADD"
        }
      ]
    }
  ],
  "scripts": [
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE VIEW records_view AS SELECT records._id, json_build_object('id', records.jsonb->>'id', 'snapshotId', records.jsonb->>'snapshotId', 'matchedProfileId', records.jsonb->>'matchedProfileId','matchedId', records.jsonb->>'matchedId','generation', records.jsonb->>'generation','recordType', records.jsonb->>'recordType', 'deleted', records.jsonb->>'deleted', 'additionalInfo', records.jsonb->'additionalInfo', 'metadata', records.jsonb->'metadata', 'rawRecord', raw_records.jsonb,'parsedRecord', COALESCE(marc_records.jsonb),'errorRecord', error_records.jsonb) AS jsonb FROM records JOIN raw_records ON records.jsonb->>'rawRecordId' = raw_records.jsonb->>'id' LEFT JOIN marc_records ON records.jsonb->>'parsedRecordId' = marc_records.jsonb->>'id' LEFT JOIN error_records ON records.jsonb->>'errorRecordId' = error_records.jsonb->>'id';",
      "fromModuleVersion": "mod-source-record-storage-2.0.0"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE VIEW source_records_view AS SELECT records._id, json_build_object('recordId', records.jsonb->>'id', 'snapshotId', records.jsonb->>'snapshotId', 'recordType', records.jsonb->>'recordType', 'deleted', records.jsonb->>'deleted', 'additionalInfo', records.jsonb->'additionalInfo', 'metadata', records.jsonb->'metadata', 'rawRecord', raw_records.jsonb, 'parsedRecord', COALESCE(marc_records.jsonb)) AS jsonb FROM records JOIN raw_records ON records.jsonb->>'rawRecordId' = raw_records.jsonb->>'id' LEFT JOIN marc_records ON records.jsonb->>'parsedRecordId' = marc_records.jsonb->>'id' WHERE records.jsonb->>'parsedRecordId' IS NOT NULL;",
      "fromModuleVersion": "mod-source-record-storage-2.0.0"
    },
    {
      "run": "after",
      "snippet": "CREATE INDEX IF NOT EXISTS records_raw_record_id_idx_btree ON records USING BTREE ((jsonb ->> 'rawRecordId'));",
      "fromModuleVersion": "mod-source-record-storage-2.3.0"
    },
    {
      "run": "after",
      "snippet": "CREATE INDEX IF NOT EXISTS records_parsed_record_id_idx_btree ON records USING BTREE ((jsonb ->> 'parsedRecordId'));",
      "fromModuleVersion": "mod-source-record-storage-2.3.0"
    },
    {
      "run": "after",
      "snippet": "CREATE INDEX IF NOT EXISTS raw_records_id_idx_btree ON raw_records USING BTREE ((jsonb ->> 'id'));",
      "fromModuleVersion": "mod-source-record-storage-2.3.0"
    },
    {
      "run": "after",
      "snippet": "CREATE INDEX IF NOT EXISTS marc_records_id_idx_btree ON marc_records USING BTREE ((jsonb ->> 'id'));",
      "fromModuleVersion": "mod-source-record-storage-2.3.0"
    },
    {
      "run": "after",
      "snippet": "CREATE INDEX IF NOT EXISTS error_records_id_idx_btree ON error_records USING BTREE ((jsonb ->> 'id'));",
      "fromModuleVersion": "mod-source-record-storage-2.3.0"
    },
    {
      "run": "after",
      "snippet": "CREATE INDEX IF NOT EXISTS records_externalIdsHolder_instanceId_idx_btree ON records USING BTREE ((jsonb -> 'externalIdsHolder' ->> 'instanceId'));"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE FUNCTION get_highest_generation(matchedId uuid, snapshotId uuid) RETURNS integer AS $generation$ DECLARE generation integer; BEGIN SELECT MAX(records.jsonb ->> 'generation') into generation FROM records INNER JOIN snapshots ON records.jsonb ->> 'snapshotId' = snapshots.jsonb ->> 'jobExecutionId' WHERE (records.jsonb ->> 'matchedId')::uuid = matchedId AND snapshots.jsonb ->> 'status' = 'COMMITTED' AND (snapshots.jsonb -> 'metadata' ->> 'updatedDate')::timestamp with time zone < (SELECT snapshots.jsonb ->> 'processingStartedDate' FROM snapshots WHERE (snapshots.jsonb ->> 'jobExecutionId')::uuid = snapshotId)::timestamp with time zone; RETURN generation; END; $generation$ LANGUAGE plpgsql;",
      "fromModuleVersion": "mod-source-record-storage-2.1.0"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE FUNCTION get_record_by_instance_id(instanceId uuid, externalIdType text)\nRETURNS jsonb AS $recordByInstId$\nDECLARE\n\trecordByInstId jsonb;\n\tidFieldName text;\nBEGIN\n  CASE\n    WHEN externalIdType = 'INSTANCE' THEN idFieldName := 'instanceId';\n  END CASE;\n\n  SELECT json_build_object('id', recordsById.jsonb->>'id',\n            'snapshotId', recordsById.jsonb->>'snapshotId',\n            'matchedProfileId', recordsById.jsonb->>'matchedProfileId',\n            'matchedId', recordsById.jsonb->>'matchedId',\n            'generation', recordsById.jsonb->>'generation',\n            'recordType', recordsById.jsonb->>'recordType',\n            'deleted', recordsById.jsonb->>'deleted',\n            'additionalInfo', recordsById.jsonb->'additionalInfo',\n            'metadata', recordsById.jsonb->'metadata',\n            'rawRecord', raw_records.jsonb,\n            'parsedRecord', COALESCE(marc_records.jsonb),\n            'errorRecord', error_records.jsonb)\n            INTO recordByInstId\n    FROM (SELECT * FROM records\n          WHERE (jsonb -> 'externalIdsHolder' ->> idFieldName)::uuid = instanceId\n            AND (jsonb ->> 'generation')::int = (SELECT MAX((jsonb ->> 'generation')::int) FROM records)) AS recordsById\n    JOIN raw_records ON recordsById.jsonb->>'rawRecordId' = raw_records.jsonb->>'id'\n    LEFT JOIN marc_records ON recordsById.jsonb->>'parsedRecordId' = marc_records.jsonb->>'id'\n    LEFT JOIN error_records ON recordsById.jsonb->>'errorRecordId' = error_records.jsonb->>'id';\n\n  RETURN recordByInstId;\nEND;\n$recordByInstId$ LANGUAGE plpgsql;",
      "fromModuleVersion": "mod-source-record-storage-2.4.0"
    }
  ]
}
